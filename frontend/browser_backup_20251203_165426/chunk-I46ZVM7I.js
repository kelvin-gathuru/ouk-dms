import"./chunk-DBWWD6JI.js";import{a as ne}from"./chunk-AKEDU32I.js";import"./chunk-KK3LA7D5.js";import{b as K}from"./chunk-ZPADZQPI.js";import"./chunk-I43MH25B.js";import"./chunk-OHUA35YV.js";import{a as $}from"./chunk-APWCXNU6.js";import{a as Y}from"./chunk-6GBRFDEJ.js";import"./chunk-4U6IWAJM.js";import"./chunk-73AGG5TT.js";import{a as X,b as Z}from"./chunk-YCBFVA3Y.js";import"./chunk-NJY6F3LT.js";import{c as re}from"./chunk-GYIDN45C.js";import"./chunk-G5E2PA5H.js";import"./chunk-DXL7FQB3.js";import"./chunk-F2N2VWHU.js";import{g as ae}from"./chunk-AHHITDV2.js";import"./chunk-QPRQJRAS.js";import{c as ie}from"./chunk-PJSVLHWR.js";import"./chunk-546GNQSA.js";import{b as V,c as j,e as N,f as k}from"./chunk-2DXU6Z77.js";import{b as W}from"./chunk-WC3ZMFX5.js";import{b as J}from"./chunk-UFOTACYY.js";import"./chunk-RKRBEXQJ.js";import"./chunk-C3OPHOKD.js";import{e as te}from"./chunk-F3ENXN4Q.js";import{E as ee}from"./chunk-KYSGX4IW.js";import{a as q}from"./chunk-LCPYESOB.js";import"./chunk-BFSIXXTJ.js";import{a as G,b as z}from"./chunk-P6E4AR6Q.js";import{ta as B,va as F}from"./chunk-GDJX5AXE.js";import{$ as g,$a as L,Ca as x,Da as C,Db as l,Ea as P,Eb as d,Fb as U,Ga as w,Ha as R,Ia as E,Ja as a,Ka as n,La as h,Pc as H,R as M,Rc as Q,Sa as b,Ua as _,W as r,Wa as y,_a as A,ab as O,ga as T,i as I,jb as o,lb as c,p as f,q as v}from"./chunk-KZMFGXDY.js";import"./chunk-W3TJXGK4.js";import"./chunk-H5HZ6YB3.js";var se=["canvas"];function ce(m,e){if(m&1&&(a(0,"div",23)(1,"div",24),h(2,"img",25),a(3,"div",26)(4,"p")(5,"strong"),o(6),l(7,"translate"),n(),o(8),n(),a(9,"p")(10,"strong"),o(11),l(12,"translate"),n(),o(13),l(14,"utcToLocalTime"),n()()()()),m&2){let t=e.$implicit;r(2),E("src","data:image/png;base64,"+t.data,M),r(4),c("",d(7,5,"ISSIGN"),":"),r(2),c(" ",t.signatureUser," "),r(3),c("",d(12,7,"SIGNDATE"),":"),r(2),c(" ",U(14,9,t.signatureDate,"full")," ")}}function me(m,e){if(m&1&&(a(0,"div",21),w(1,ce,15,12,"div",23,P),n()),m&2){let t=y();r(),R(t.documentSignatures)}}function le(m,e){m&1&&(a(0,"div",22),h(1,"mat-progress-spinner",27),n())}var oe=class m{constructor(e,t,i,s,u,S){this.toastrService=e;this.translationService=t;this.documentService=i;this.commonService=s;this.dialogRef=u;this.data=S}canvasRef;signaturePad;isLoading=!1;documentSignatures=[];uploadedSignature=null;documentStore=I(K);mode="indeterminate";ngOnInit(){this.initializeSignaturePad(),this.getDocumentSignatures()}getDocumentSignatures(){this.documentService.getDocumentSignature(this.data?.id).subscribe(e=>{this.documentSignatures=e})}initializeSignaturePad(){let e=this.canvasRef.nativeElement;this.signaturePad=new ne(e),this.signaturePad.addEventListener("beginStroke",()=>{if(this.uploadedSignature){this.uploadedSignature=null;let t=document.querySelector('input[type="file"].signature-upload');t&&(t.value="")}}),this.resizeCanvas()}resizeCanvas(){let e=this.canvasRef.nativeElement,t=Math.max(window.devicePixelRatio||1,1);e.width=e.offsetWidth*t,e.height=e.offsetHeight*t;let i=e.getContext("2d");i&&i.scale(t,t)}clearSignature(){this.signaturePad.clear()}saveSignature(){let e=null;if(this.signaturePad&&!this.signaturePad.isEmpty()?e=this.signaturePad.toDataURL():this.uploadedSignature&&(e=this.uploadedSignature),!e||e==="data:image/png;base64,"||e==="data:image/jpeg;base64,"){this.toastrService.error(this.translationService.getValue("PLEASE_PROVIDE_SIGNATURE"));return}this.uploadSignature(e)}uploadSignature(e){this.isLoading=!0;let t={documentId:this.data.id,signatureUrl:e};this.documentService.saveDocumentSignature(t).subscribe({next:i=>{this.isLoading=!1,this.documentSignatures.push(i),this.addDocumentTrail(i.documentId),this.dialogRef.close(t),this.uploadedSignature=null,this.signaturePad?.clear()},error:()=>{this.isLoading=!1,this.toastrService.error(this.translationService.getValue("SIGNATURE_UPLOAD_FAILED"))}})}onFileSelected(e){let i=e.target.files?.[0];if(!i)return;if(i.type!=="image/png"&&i.type!=="image/jpeg"){this.toastrService.error(this.translationService.getValue("INVALID_FILE_TYPE"));return}let s=new FileReader;s.onload=()=>{let u=new Image;u.src=s.result,u.onload=()=>{let S=this.canvasRef.nativeElement;if(!S.getContext("2d"))return;let p=document.createElement("canvas");p.width=S.width,p.height=S.height;let D=p.getContext("2d");D&&(D.clearRect(0,0,p.width,p.height),D.drawImage(u,0,0,p.width,p.height),this.uploadedSignature=p.toDataURL(i.type==="image/jpeg"?"image/jpeg":"image/png"),this.signaturePad.clear())}},s.readAsDataURL(i)}addDocumentTrail(e){let t={documentId:e,operationName:10 .toString()};this.isLoading=!1,this.toastrService.success(this.translationService.getValue("SIGNATURE_SAVED_SUCCESSFULLY")),this.documentStore.addDocumentAudit(t)}closeDialog(){this.dialogRef.close()}static \u0275fac=function(t){return new(t||m)(g(W),g(q),g($),g(J),g(V),g(j))};static \u0275cmp=T({type:m,selectors:[["app-document-signature"]],viewQuery:function(t,i){if(t&1&&A(se,7),t&2){let s;L(s=O())&&(i.canvasRef=s.first)}},decls:42,vars:21,consts:[["canvas",""],[1,"d-flex"],[1,"me-auto","p-2"],[1,"mb-3","page-title"],[3,"code"],[1,"d-flex","justify-content-end","mb-2"],[1,"close-icon","text-danger","cursor-pointer",3,"click"],[1,"row"],["for","signature"],[1,"col-md-12"],[1,"signature-container"],["width","600","height","200",2,"border","1px solid #ccc","width","100%","max-width","50vw","max-height","90vh"],["for","or",1,"text-danger","d-flex","justify-content-center","align-items-center","m-2","w-100"],[1,"col-sm-12"],[1,"form-group"],["type","file","accept","image/png, image/jpeg",1,"form-control","signature-upload",3,"change"],[1,"mt-2","col-md-12"],["type","button","matButton","filled","cdkFocusInitial","",1,"success","me-2",3,"click"],[1,"medium-icon"],["type","button","matButton","filled",1,"error",3,"click"],[1,"row","mt-2"],[1,"row","mb-3"],[1,"spinner-container"],[1,"col-md-6"],[1,"previous-signature"],["alt","Signature",1,"signature-img",3,"src"],[1,"signature-details"],["mode","indeterminate","diameter","60","strokeWidth","5"]],template:function(t,i){if(t&1){let s=b();a(0,"mat-dialog-content")(1,"div",1)(2,"div",2)(3,"span",3),o(4),l(5,"translate"),h(6,"app-page-help-text",4),n()(),a(7,"div",5)(8,"mat-icon",6),_("click",function(){return f(s),v(i.closeDialog())}),o(9,"cancel"),n()()(),a(10,"div",7)(11,"label",8),o(12),l(13,"translate"),n(),a(14,"div",9)(15,"div",10),h(16,"canvas",11,0),n()(),a(18,"label",12),o(19),l(20,"translate"),n(),a(21,"div",13)(22,"div",14)(23,"label",8),o(24),l(25,"translate"),n(),a(26,"input",15),_("change",function(S){return f(s),v(i.onFileSelected(S))}),n()()(),a(27,"div",16)(28,"button",17),_("click",function(){return f(s),v(i.saveSignature())}),a(29,"mat-icon",18),o(30,"save"),n(),o(31),l(32,"translate"),n(),a(33,"button",19),_("click",function(){return f(s),v(i.clearSignature())}),a(34,"mat-icon",18),o(35,"cancel"),n(),o(36),l(37,"translate"),n()()(),a(38,"div",20)(39,"div",9),x(40,me,3,0,"div",21),n()(),x(41,le,2,0,"div",22),n()}t&2&&(r(4),c(" ",d(5,9,"DOCUMENT_SIGNATURE")," "),r(2),E("code","DOCUMENT_SIGNATURE"),r(6),c(" ",d(13,11,"ADD_YOUR_SIGNATURE")),r(7),c(" ",d(20,13,"OR")),r(5),c(" ",d(25,15,"UPLOAD_YOUR_SIGNATURE")),r(7),c(" ",d(32,17,"SAVE")," "),r(5),c(" ",d(37,19,"CLEAR")," "),r(4),C(i.documentSignatures.length>0?40:-1),r(),C(i.isLoading?41:-1))},dependencies:[k,N,ee,F,B,ae,re,Z,X,ie,Q,te,z,G,H,Y],styles:[".signature-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center}.signature-container[_ngcontent-%COMP%]   canvas[_ngcontent-%COMP%]{border:1px solid #ccc;width:100%;max-width:60vw;max-height:60vh;background-color:#fff}.signature-container[_ngcontent-%COMP%]   .controls[_ngcontent-%COMP%]{margin-top:10px;display:flex;gap:10px}.previous-signature[_ngcontent-%COMP%]{display:flex;align-items:center;margin-bottom:1rem}.previous-signature[_ngcontent-%COMP%]   .signature-img[_ngcontent-%COMP%]{width:200px;height:55px;margin-right:1rem;border:1px solid #ddd}.previous-signature[_ngcontent-%COMP%]   .signature-details[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0}"]})};export{oe as DocumentSignatureComponent};
