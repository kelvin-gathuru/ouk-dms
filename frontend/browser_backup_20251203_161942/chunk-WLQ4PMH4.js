import{a as Ae}from"./chunk-DUWNNMPN.js";import{a as Oe}from"./chunk-LTSUZ232.js";import{a as he}from"./chunk-YYODLXEO.js";import{a as Ie}from"./chunk-D6HICPES.js";import{a as Fe}from"./chunk-TC5US2P6.js";import{b as ye}from"./chunk-WFK47GYZ.js";import{a as ce}from"./chunk-DD7TOTAW.js";import{b as _e}from"./chunk-VX5UXB3Q.js";import{c as ke}from"./chunk-BBTJI4ZO.js";import{a as pe}from"./chunk-6MWAWDLF.js";import{a as Ue}from"./chunk-3NQBK7XS.js";import{a as se}from"./chunk-6GBRFDEJ.js";import{a as fe,b as De}from"./chunk-GE3TJVIQ.js";import{a as le}from"./chunk-ZXWR2MAY.js";import{c as Ne}from"./chunk-756DJ4VK.js";import{a as Ce}from"./chunk-JYYDN77K.js";import{b as X,c as J,d as K,e as Z,f as ee}from"./chunk-BQ4MMRNN.js";import{b as de}from"./chunk-JSAPTJHL.js";import{b as ue}from"./chunk-UFOTACYY.js";import{e as Te}from"./chunk-THB5JDTQ.js";import{a as ne,b as oe}from"./chunk-4E37NPLR.js";import{ta as te,va as ie}from"./chunk-56QOWAU7.js";import{a as me}from"./chunk-77WXBMFN.js";import{C as Ee,E as be,c as ve,e as R,h as Se,i as xe,o as ge,r as we,u as Ve}from"./chunk-KYSGX4IW.js";import{$ as f,Ca as h,Da as C,Db as d,Ea as j,Eb as _,Ec as Q,Fb as I,Ga as G,Ha as H,Ia as w,Ja as n,Ka as r,La as N,Pc as re,Rc as ae,Sa as V,Ua as x,W as s,Wa as u,Yb as q,eb as W,ga as P,i as A,jb as m,ka as $,kb as D,lb as g,ma as T,mb as z,p as v,q as S,zb as Y}from"./chunk-KZMFGXDY.js";import{I as k,Ja as O,_ as F,_b as B,za as U}from"./chunk-W3TJXGK4.js";import{p as y}from"./chunk-H5HZ6YB3.js";var Le=()=>["ALL_UPLOAD_NEW_VERSION","ASSIGNED_UPLOAD_NEW_VERSION"];function Me(i,p){i&1&&(n(0,"div",23),m(1),d(2,"translate"),r()),i&2&&(s(),g(" ",_(2,1,"DOCUMENT_IS_REQUIRED")," "))}function Be(i,p){if(i&1&&h(0,Me,3,3,"div",23),i&2){let e,o=u();C(!((e=o.documentForm.get("url"))==null||e.errors==null)&&e.errors.required?0:-1)}}function Pe(i,p){i&1&&(n(0,"div",23),m(1),d(2,"translate"),r()),i&2&&(s(),g(" ",_(2,1,"DOCUMENT_TYPE_IS_NOT_ALLOW")," "))}function $e(i,p){if(i&1&&h(0,Pe,3,3,"div",23),i&2){let e,o=u();C(!((e=o.documentForm.get("extension"))==null||e.errors==null)&&e.errors.required?0:-1)}}function je(i,p){if(i&1){let e=V();n(0,"button",24),x("click",function(){v(e);let t=u();return S(t.SaveDocument())}),n(1,"mat-icon",16),m(2,"save"),r(),m(3),d(4,"translate"),r()}i&2&&(s(3),g(" ",_(4,1,"SAVE")," "))}function Ge(i,p){if(i&1&&m(0),i&2){let e=u().$implicit;g(" ",e.signBy," ")}}function He(i,p){if(i&1&&(m(0),d(1,"utcToLocalTime")),i&2){let e=u().$implicit;g(" ",I(1,1,e.signDate,"short")," ")}}function We(i,p){if(i&1){let e=V();n(0,"span",27),x("click",function(){v(e);let t=u().$implicit,a=u();return S(a.showComment(t.comment))}),n(1,"mat-icon"),m(2," chat"),r()()}}function ze(i,p){i&1&&(n(0,"span",26),m(1),d(2,"translate"),r()),i&2&&(s(),g("",_(2,1,"CURRENT_VERSION")," "))}function Ye(i,p){if(i&1){let e=V();n(0,"span",31),x("click",function(){v(e);let t=u(3).$implicit,a=u();return S(a.downloadDocument(t))}),n(1,"mat-icon"),m(2," download"),r()()}}function qe(i,p){if(i&1){let e=V();n(0,"span",32),x("click",function(){v(e);let t=u(3).$implicit,a=u();return S(a.restoreDocumentVersion(t))}),n(1,"mat-icon"),m(2," restore"),r()()}}function Qe(i,p){i&1&&T(0,Ye,3,0,"span",29)(1,qe,3,0,"span",30),i&2&&(w("hasClaim","ALL_DOWNLOAD_DOCUMENT"),s(),w("hasClaim","ALL_RESTORE_VERSION"))}function Xe(i,p){if(i&1){let e=V();n(0,"span",31),x("click",function(){v(e);let t=u(3).$implicit,a=u();return S(a.downloadDocument(t))}),n(1,"mat-icon"),m(2," download"),r()()}}function Je(i,p){if(i&1){let e=V();n(0,"span",32),x("click",function(){v(e);let t=u(3).$implicit,a=u();return S(a.restoreDocumentVersion(t))}),n(1,"mat-icon"),m(2," restore"),r()()}}function Ke(i,p){i&1&&T(0,Xe,3,0,"span",29)(1,Je,3,0,"span",30),i&2&&(w("hasClaim","ASSIGNED_DOWNLOAD_DOCUMENT"),s(),w("hasClaim","ASSIGNED_RESTORE_VERSION"))}function Ze(i,p){if(i&1){let e=V();n(0,"div")(1,"span",28),x("click",function(){v(e);let t=u().$implicit,a=u();return S(a.onDocumentView(t))}),n(2,"mat-icon"),m(3," visibility"),r()(),h(4,Qe,2,2)(5,Ke,2,2),r()}if(i&2){let e=u(2);s(4),C(e.data.isAssignUser?5:4)}}function et(i,p){if(i&1&&(n(0,"tr")(1,"td"),m(2),r(),n(3,"td"),m(4),d(5,"utcToLocalTime"),r(),n(6,"td"),m(7),r(),n(8,"td"),h(9,Ge,1,1),r(),n(10,"td"),h(11,He,2,4),r(),n(12,"td"),h(13,We,3,0,"span",25),r(),n(14,"td"),h(15,ze,3,3,"span",26),h(16,Ze,6,1,"div"),r()()),i&2){let e=p.$implicit;s(2),D(e.versionNumber),s(2),D(I(5,8,e.modifiedDate,"full")),s(3),g(" ",e.createdByUser," "),s(2),C(e.signBy?9:-1),s(2),C(e.signBy?11:-1),s(2),C(e.comment?13:-1),s(2),C(e.isCurrentVersion?15:-1),s(),C(e.isCurrentVersion?-1:16)}}function tt(i,p){i&1&&(n(0,"tr")(1,"td",33),m(2),d(3,"translate"),r()()),i&2&&(s(2),g(" ",_(3,1,"NO_DATA_FOUND")," "))}function it(i,p){if(i&1&&(n(0,"div",22),N(1,"mat-progress-spinner",34),r()),i&2){let e=u();s(),w("mode",e.mode)("value",e.progress)}}var Re=class i extends le{constructor(e,o,t,a,l,c,b,L,M,E,nt){super();this.fb=e;this.data=o;this.cd=t;this.dialogRef=a;this.documentService=l;this.toastrService=c;this.commonService=b;this.securityService=L;this.overlay=M;this.dialog=E;this.commandDialogService=nt}isLoadingResults=!1;documentForm;allowFileExtension=[];fileData;extension="";documentVersions=[];progress=0;documentChunks=[];contentType="";documentChunkDownloads=[];documentUrl;isLoading=!1;mode="determinate";documentStore=A(_e);chunkSize=ce.chunkSize;foldersViewStore=A(he);ngOnInit(){this.createDocumentForm(),this.getAllAllowFileExtension(),this.getDocumentHistories()}getDocumentHistories(){this.sub$.sink=this.documentService.getDocumentVersion(this.data.id).subscribe(e=>{this.documentVersions=e})}createDocumentForm(){this.documentForm=this.fb.group({url:["",[R.required]],extension:["",[R.required]],comment:[""]})}getAllAllowFileExtension(){this.commonService.getAllowFileExtensions().subscribe(),this.sub$.sink=this.commonService.allowFileExtension$.subscribe(e=>{e&&(this.allowFileExtension=e)})}upload(e){return y(this,null,function*(){if(!(!e||e.length===0)){if(!(yield Ue(e[0]))){this.fileUploadExtensionValidation(""),this.toastrService.error(this.translationService.getValue("INVALID_EXTENSION_OR_CORRUPT_INVALID_SIGNATURE")),this.cd.markForCheck();return}if(this.extension=e[0].name.split(".").pop()??"",this.fileExtesionValidation(this.extension))this.fileUploadExtensionValidation("valid");else{this.fileUploadExtensionValidation(""),this.cd.markForCheck();return}this.fileData=e[0],this.documentForm.get("url")?.setValue(e[0].name)}})}fileUploadValidation(e){this.documentForm.patchValue({url:e}),this.documentForm.get("url")?.markAsTouched(),this.documentForm.updateValueAndValidity()}fileUploadExtensionValidation(e){this.documentForm.patchValue({extension:e}),this.documentForm.get("extension")?.markAsTouched(),this.documentForm.updateValueAndValidity()}fileExtesionValidation(e){var t=this.allowFileExtension.find(a=>a.extensions?.find(l=>l.toLowerCase()===e.toLowerCase()));return!!t}SaveDocument(){if(this.documentForm.invalid){this.documentForm.markAllAsTouched();return}let e=this.commonService.getInternetSpeed();if(this.fileData.size>this.chunkSize)this.saveDocumentChunk();else{let o={documentId:this.data.id,url:this.documentForm.get("url")?.value,file:this.fileData,extension:this.extension,comment:this.documentForm.get("comment")?.value};this.sub$.sink=this.documentService.saveNewVersionDocument(o).subscribe(t=>{this.toastrService.success(this.translationService.getValue("DOCUMENT_SAVE_SUCCESSFULLY")),this.documentStore.loadDocuments(),this.foldersViewStore.selectedCategoryId()==t.categoryId&&(this.foldersViewStore.setDocumentsEmpty(),this.foldersViewStore.loadDocumentsByCategory(this.foldersViewStore.selectedCategoryId())),this.dialogRef.close(!0)})}}saveDocumentChunk(){let e={documentId:this.data.id,url:this.documentForm.get("url")?.value,extension:this.extension,comment:this.documentForm.get("comment")?.value};this.documentService.saveNewVersionDocumentChunk(e).subscribe(o=>{this.uploadFileInChunks(o.id??"")})}uploadFileInChunks(e){if(!this.fileData)return;this.isLoading=!0;let{chunkSize1:o,parallelCalls:t}=this.commonService.getNetworkSpeed(),a=Math.ceil(this.fileData.size/this.chunkSize),l=[];this.progress=0;for(let c=0;c<a;c++){let b=c*this.chunkSize,L=Math.min(b+this.chunkSize,this.fileData.size),M=this.fileData.slice(b,L),E=new FormData;E.append("file",M),E.append("chunkIndex",c.toString()),E.append("size",this.chunkSize.toString()),E.append("totalChunks",a.toString()),E.append("extension",this.extension),E.append("documentVersionId",e),l.push(E)}this.sub$.sink=k(l).pipe(U(t),O(c=>k(c).pipe(B(()=>console.log("Processing batch:",c)),F(b=>this.uploadChunk(b),t)))).subscribe({next:c=>{this.progress=Math.min(this.progress+100/a,100),this.cd.markForCheck()},complete:()=>{this.progress=100,this.isLoading=!1,this.markChunkAsUploaded(),this.toastrService.success(this.translationService.getValue("DOCUMENT_SAVE_SUCCESSFULLY")),this.cd.markForCheck()},error:c=>{this.markChunkAsUploaded(!1),this.isLoading=!1,this.cd.markForCheck()}})}uploadChunk(e){return this.documentService.uploadChunkDocument(e)}markChunkAsUploaded(e=!0){this.isLoading=!0,this.commonService.markChunkAsUploaded(this.data.id,e).subscribe({next:o=>{this.isLoading=!1},error:o=>{this.isLoading=!1}})}closeDialog(){this.dialogRef.close()}onDocumentView(e){return y(this,null,function*(){this.isLoadingResults=!0;try{let t=(e?.url?.split(".")??[])[1],a={documentId:this.data.id,name:this.data.name,extension:e.extension,isVersion:!0,id:this.data.id,isFromPublicPreview:!1,isPreviewDownloadEnabled:this.securityService.hasClaim("ALL_DOWNLOAD_DOCUMENT"),isFileRequestDocument:!1,isSignatureExists:e.isSignatureExists,url:e.url,comment:e.comment,documentVersionId:e.id,isChunk:e.isChunk,documentNumber:this.data.documentNumber},{BasePreviewComponent:l}=yield import("./chunk-JJBHCVNV.js");this.overlay.open(l,{position:"center",origin:"global",panelClass:["file-preview-overlay-container","white-background"],data:a})}finally{this.isLoadingResults=!1}})}restoreDocumentVersion(e){this.sub$.sink=this.commandDialogService.deleteConfirmtionDialog(this.translationService.getValue("ARE_YOU_SURE_YOU_WANT_TO_RESTORE_THIS_TO_CURRENT_VERSION")).subscribe(o=>{o&&(this.sub$.sink=this.documentService.restoreDocumentVersion(this.data.id,e.id??"").subscribe(()=>{this.toastrService.success(this.translationService.getValue("VERSION_RESTORED_SUCCESSFULLY")),this.addDocumentTrail(this.data.id,13 .toString()),this.documentStore.loadDocuments(),this.foldersViewStore.selectedCategoryId()==this.data.categoryId&&(this.foldersViewStore.setDocumentsEmpty(),this.foldersViewStore.loadDocumentsByCategory(this.foldersViewStore.selectedCategoryId())),this.getDocumentHistories()}))})}downloadDocument(e){if(e.isChunk)this.getAllDocumentChunks(e.id??"");else{let o={documentId:this.data.id,name:"",extension:e.url?.split(".")[1],isVersion:!0,isFromPublicPreview:!1,isPreviewDownloadEnabled:!1,isFileRequestDocument:!1,isSignatureExists:!1,comment:e.comment,documentVersionId:e.id,documentNumber:this.data.documentNumber};this.sub$.sink=this.commonService.downloadDocument(o).subscribe({next:t=>{t.type===Q.Response&&(this.addDocumentTrail(this.data.id,8 .toString()),t.body?(this.documentUrl=new Blob([t.body],{type:t.body.type}),this.downloadFile()):this.toastrService.error(this.translationService.getValue("ERROR_WHILE_DOWNLOADING_DOCUMENT")))},error:t=>{this.toastrService.error(this.translationService.getValue("ERROR_WHILE_DOWNLOADING_DOCUMENT"))}})}}getAllDocumentChunks(e){this.sub$.sink=this.commonService.getDocumentChunks(e).subscribe({next:o=>{this.documentChunks=o,this.documentChunks.length>0&&this.startDownload(e)},error:o=>{this.toastrService.error(o.error.message)}})}startDownload(e){this.progress=0,this.isLoading=!0;let{chunkSize1:o,parallelCalls:t}=this.commonService.getNetworkSpeed(),a=[];for(let l=0;l<this.documentChunks.length;l++)a.push(l);this.sub$.sink=k(a).pipe(U(t),O(l=>k(l).pipe(F(c=>this.downloadChunk(c,e),t)))).subscribe({next:l=>{this.progress=Math.min(this.progress+100/a.length,100),this.contentType=l.contentType;let c=this.base64ToBlob(l.data,l.contentType);l.blobChunk=c,this.documentChunkDownloads.push(l)},complete:()=>this.mergeChunks(),error:l=>{this.isLoading=!1,console.error("Error downloading chunks",l)}})}downloadChunk(e,o){return this.commonService.downloadDocumentChunk(o,e)}mergeChunks(){this.progress=100,this.isLoading=!1;let e=this.documentChunkDownloads.sort((t,a)=>t.chunkIndex-a.chunkIndex).map(t=>t.blobChunk).filter(t=>t!==void 0),o=new Blob(e,{type:this.contentType});this.documentUrl=o,this.downloadFile()}base64ToBlob(e,o){let t=atob(e),a=new Array(t.length);for(let c=0;c<t.length;c++)a[c]=t.charCodeAt(c);let l=new Uint8Array(a);return new Blob([l],{type:o})}addDocumentTrail(e,o){let t={documentId:e,operationName:o};this.documentStore.addDocumentAudit(t)}downloadFile(){let e=document.createElement("a");e.setAttribute("style","display:none;"),document.body.appendChild(e),e.download=this.data.name,e.href=URL.createObjectURL(this.documentUrl),e.target="_blank",e.click(),document.body.removeChild(e)}showComment(e){let o=this.dialog.open(Ae,{width:"800px",maxHeight:"70vh",data:e})}static \u0275fac=function(o){return new(o||i)(f(Ee),f(J),f(q),f(X),f(pe),f(de),f(ue),f(me),f(ke),f(K),f(Oe))};static \u0275cmp=P({type:i,selectors:[["app-document-upload-new-version"]],features:[$],decls:71,vars:48,consts:[["file",""],[1,"d-flex"],[1,"me-auto","p-2"],[1,"mb-3","page-title"],[3,"code"],[1,"d-flex","justify-content-end","mb-2"],[1,"close-icon","text-danger","cursor-pointer",3,"click"],[3,"formGroup"],[1,"row"],[1,"col-md-12"],[1,"form-group"],["type","file",1,"form-control",3,"change"],["formControlName","comment","rows","2",1,"form-control"],[1,"col-12","d-flex","flex-column","flex-sm-row","gap-2","mt-2"],["class","success me-2","matButton","filled","cdkFocusInitial","",3,"click",4,"hasClaim"],["type","button","matButton","filled",1,"error",3,"click"],[1,"medium-icon"],[1,"col-md-12","mt-5"],[1,"dialog-title"],[1,"row","mt-2"],[1,"table-responsive"],[1,"table","table-pos","table_color"],[1,"spinner-container"],[1,"text-danger"],["matButton","filled","cdkFocusInitial","",1,"success","me-2",3,"click"],["role","button","matTooltip","Comment",1,"me-2","text-primary"],[1,"badge","bg-success"],["role","button","matTooltip","Comment",1,"me-2","text-primary",3,"click"],["matTooltip","view","role","button",1,"material-icons-outlined","me-2","text-primary",3,"click"],["role","button","class","me-2 text-primary","matTooltip","Download",3,"click",4,"hasClaim"],["role","button","matTooltip","Restore to Current Version","class","material-icons-outlined text-primary",3,"click",4,"hasClaim"],["role","button","matTooltip","Download",1,"me-2","text-primary",3,"click"],["role","button","matTooltip","Restore to Current Version",1,"material-icons-outlined","text-primary",3,"click"],["colspan","5",1,"text-center"],["diameter","60","strokeWidth","5",1,"example-margin",3,"mode","value"]],template:function(o,t){if(o&1){let a=V();n(0,"mat-dialog-content")(1,"div",1)(2,"div",2)(3,"span",3),m(4),d(5,"translate"),N(6,"app-page-help-text",4),r()(),n(7,"div",5)(8,"mat-icon",6),x("click",function(){return v(a),S(t.closeDialog())}),m(9,"cancel"),r()()(),n(10,"form",7)(11,"div",8)(12,"div",9)(13,"div",10)(14,"label"),m(15),d(16,"translate"),r(),n(17,"input",11,0),x("change",function(){v(a);let c=W(18);return S(t.upload(c.files))}),r(),h(19,Be,1,1),h(20,$e,1,1),r(),n(21,"div",10)(22,"label"),m(23),d(24,"translate"),r(),N(25,"textarea",12),r()()(),n(26,"div",8)(27,"div",13),T(28,je,5,3,"button",14),n(29,"button",15),x("click",function(){return v(a),S(t.closeDialog())}),n(30,"mat-icon",16),m(31,"cancel"),r(),m(32),d(33,"translate"),r()()(),n(34,"div",8)(35,"div",17)(36,"span",18),m(37),d(38,"limitTo"),d(39,"translate"),r()()(),n(40,"div",19)(41,"div",20)(42,"table",21)(43,"thead")(44,"tr")(45,"th"),m(46),d(47,"translate"),r(),n(48,"th"),m(49),d(50,"translate"),r(),n(51,"th"),m(52),d(53,"translate"),r(),n(54,"th"),m(55),d(56,"translate"),r(),n(57,"th"),m(58),d(59,"translate"),r(),n(60,"th"),m(61),d(62,"translate"),r(),n(63,"th"),m(64),d(65,"translate"),r()()(),n(66,"tbody"),G(67,et,17,11,"tr",null,j),h(69,tt,4,3,"tr"),r()()()()(),h(70,it,2,2,"div",22),r()}if(o&2){let a,l;s(4),g(" ",_(5,20,"UPLOAD_NEW_VERSION_FILE")," "),s(2),w("code","UPLOAD_NEW_VERSION"),s(4),w("formGroup",t.documentForm),s(5),D(_(16,22,"DOCUMENT_UPLOAD")),s(4),C(((a=t.documentForm.get("url"))!=null&&a.touched||(a=t.documentForm.get("url"))!=null&&a.dirty)&&((a=t.documentForm.get("url"))!=null&&a.errors)?19:-1),s(),C(((l=t.documentForm.get("extension"))!=null&&l.touched||(l=t.documentForm.get("extension"))!=null&&l.dirty)&&((l=t.documentForm.get("url"))!=null&&l.errors)?20:-1),s(3),D(_(24,24,"COMMENT")),s(5),w("hasClaim",Y(47,Le)),s(4),g(" ",_(33,26,"CANCEL")," "),s(5),z(" ",I(38,28,t.data.name,"100")," ::",_(39,31,"VERSION_HISTORY")," "),s(9),D(_(47,33,"VERSION_NO")),s(3),D(_(50,35,"MODIFIED_DATE")),s(3),D(_(53,37,"CREATED_BY")),s(3),D(_(56,39,"SIGNBY")),s(3),D(_(59,41,"SIGNDATE")),s(3),D(_(62,43,"COMMENT")),s(3),D(_(65,45,"ACTIONS")),s(3),H(t.documentVersions),s(2),C(t.documentVersions.length===0?69:-1),s(),C(t.isLoading||t.isLoadingResults?70:-1)}},dependencies:[be,ge,ve,Se,xe,we,Ve,ee,Z,ie,te,Ne,Fe,ye,De,fe,Ce,ae,oe,ne,Te,re,Ie,se],encapsulation:2})};export{Re as a};
