import{a as me}from"./chunk-E4NKSOB7.js";import{a as _e}from"./chunk-AKEDU32I.js";import{a as oe}from"./chunk-DD7TOTAW.js";import{b as le}from"./chunk-ZPADZQPI.js";import{c as De}from"./chunk-2OJALU77.js";import{a as ae}from"./chunk-APWCXNU6.js";import{a as we}from"./chunk-3NQBK7XS.js";import{a as Ie}from"./chunk-KCPEL47F.js";import{a as ce,b as de}from"./chunk-YCBFVA3Y.js";import{a as ie}from"./chunk-ZXWR2MAY.js";import{c as Ce}from"./chunk-PJSVLHWR.js";import{b as H,c as Q,e as Y,f as $}from"./chunk-2DXU6Z77.js";import{b as re}from"./chunk-WC3ZMFX5.js";import{b as se}from"./chunk-UFOTACYY.js";import{a as ne}from"./chunk-RKRBEXQJ.js";import{e as xe}from"./chunk-F3ENXN4Q.js";import{B as ve,E as Se,c as ue,e as R,h as pe,i as fe,r as he,u as ge}from"./chunk-KYSGX4IW.js";import{a as J,b as Z}from"./chunk-P6E4AR6Q.js";import{$ as G,ta as K,va as X}from"./chunk-GDJX5AXE.js";import{$ as p,$a as B,Ca as x,Da as C,Db as c,Eb as d,Ia as b,Ja as o,Ka as n,La as I,Pc as ee,Rc as te,Sa as F,Ua as v,W as a,Wa as _,Yb as q,_a as N,ab as j,eb as z,ga as O,i as k,jb as l,ka as W,kb as V,lb as h,p as E,q as T}from"./chunk-KZMFGXDY.js";import{I as P,Ja as A,_ as M,_b as L,za as U}from"./chunk-W3TJXGK4.js";import{p as y}from"./chunk-H5HZ6YB3.js";var Ee=["canvas"];function Te(s,w){s&1&&(o(0,"div",22),l(1),c(2,"translate"),n()),s&2&&(a(),h(" ",d(2,1,"DOCUMENT_IS_REQUIRED")," "))}function Ve(s,w){s&1&&(o(0,"div",22),l(1),c(2,"translate"),n()),s&2&&(a(),h(" ",d(2,1,"DOCUMENT_TYPE_IS_NOT_ALLOW")," "))}function Pe(s,w){if(s&1){let e=F();o(0,"div",9)(1,"div",19)(2,"div",20)(3,"label"),l(4),c(5,"translate"),n(),o(6,"input",21,0),v("change",function(){E(e);let i=z(7),r=_();return T(r.upload(i.files))}),n(),x(8,Te,3,3,"div",22),x(9,Ve,3,3,"div",22),n()()()}if(s&2){let e,t,i=_();a(4),V(d(5,3,"DOCUMENT_UPLOAD")),a(4),C((e=i.performDocumentWorkflowForm.get("url"))!=null&&e.touched&&(!((e=i.performDocumentWorkflowForm.get("url"))==null||e.errors==null)&&e.errors.required)?8:-1),a(),C((t=i.performDocumentWorkflowForm.get("extension"))!=null&&t.touched&&(!((t=i.performDocumentWorkflowForm.get("extension"))==null||t.errors==null)&&t.errors.required)?9:-1)}}function be(s,w){if(s&1){let e=F();o(0,"div",9)(1,"label",23),l(2),c(3,"translate"),o(4,"sup"),l(5,"*"),n()(),o(6,"div",14)(7,"div",24),I(8,"canvas",null,1),n()(),o(10,"label",25),l(11),c(12,"translate"),n(),o(13,"div",19)(14,"div",20)(15,"label",26),l(16),c(17,"translate"),n(),o(18,"input",27),v("change",function(i){E(e);let r=_();return T(r.onFileSelected(i))}),n()()(),o(19,"div",28)(20,"button",17),v("click",function(){E(e);let i=_();return T(i.clearSignature())}),o(21,"mat-icon",29),l(22,"cancel"),n(),l(23),c(24,"translate"),n()()()}s&2&&(a(2),h(" ",d(3,4,"ADD_YOUR_SIGNATURE")," "),a(9),V(d(12,6,"OR")),a(5),h(" ",d(17,8,"UPLOAD_YOUR_SIGNATURE")),a(7),h(" ",d(24,10,"CLEAR")," "))}function Fe(s,w){if(s&1&&(o(0,"div",18),I(1,"mat-progress-spinner",30),n()),s&2){let e=_();a(),b("mode",e.mode)("value",e.progress)}}var ke=class s extends ie{constructor(e,t,i,r,f,m,S,u,D){super();this.dialogRef=e;this.fb=t;this.data=i;this.cd=r;this.toastrService=f;this.commonService=m;this.workflowInstanceService=S;this.documentService=u;this.overlay=D}canvasRef;signaturePad;performDocumentWorkflowForm;allowFileExtension=[];fileData;extension="";documentStore=k(le);isLoading=!1;progress=0;documentVersionId;mode="determinate";chunkSize=oe.chunkSize;uploadedSignature=null;securityService=k(ne);foldersViewStore=k(me);document;documentInfo;isPdf=!1;isSignatureShow=!1;ngAfterViewInit(){setTimeout(()=>{this.canvasRef?.nativeElement&&this.initializeSignaturePad()})}ngOnInit(){this.isSignatureShow=!!(this.data.isSignatureRequired&&!this.data.isUploadDocumentVersion),this.getDocumentInfo(),this.getAllAllowFileExtension(),this.createPerformDocumentWorkflowForm()}getDocumentInfo(){this.documentService.getDocumentDetail(this.data.documentId??"").subscribe({next:e=>{this.documentInfo=e},error:e=>{this.isLoading=!1}})}getAllAllowFileExtension(){this.commonService.getAllowFileExtensions().subscribe(),this.sub$.sink=this.commonService.allowFileExtension$.subscribe(e=>{e&&(this.allowFileExtension=e)})}initializeSignaturePad(){let e=this.canvasRef.nativeElement;this.signaturePad=new _e(e,{backgroundColor:"#fff",penColor:"black"}),this.resizeCanvas()}resizeCanvas(){let e=this.canvasRef.nativeElement,t=Math.max(window.devicePixelRatio||1,1);e.width=e.offsetWidth*t,e.height=e.offsetHeight*t,e.getContext("2d")?.scale(t,t)}clearSignature(){this.signaturePad.clear(),this.uploadedSignature=null}upload(e){return y(this,null,function*(){if(!(!e||e.length===0)){if(!e[0]||!(yield we(e[0]))){this.toastrService.error(this.translationService.getValue("INVALID_EXTENSION_OR_CORRUPT_INVALID_SIGNATURE")),this.fileUploadExtensionValidation(""),this.cd.markForCheck();return}if(this.extension=e[0].name.split(".").pop()??"",this.fileExtesionValidation(this.extension))this.fileUploadExtensionValidation("valid");else{this.fileUploadExtensionValidation(""),this.cd.markForCheck();return}this.fileData=e[0],this.performDocumentWorkflowForm.get("url")?.setValue(e[0].name)}})}fileUploadExtensionValidation(e){this.performDocumentWorkflowForm.patchValue({extension:e}),this.performDocumentWorkflowForm.get("extension")?.markAsTouched(),this.performDocumentWorkflowForm.updateValueAndValidity()}fileExtesionValidation(e){return!!this.allowFileExtension.find(r=>r.extensions?.find(f=>f.toLowerCase()===e.toLowerCase()))}createPerformDocumentWorkflowForm(){this.performDocumentWorkflowForm=this.fb.group({comment:[""],url:[""],extension:[""]}),this.data.isUploadDocumentVersion&&(this.performDocumentWorkflowForm.get("url")?.setValidators([R.required]),this.performDocumentWorkflowForm.get("extension")?.setValidators([R.required]),this.performDocumentWorkflowForm.updateValueAndValidity())}get userAlreadySigned(){return!!(this.data?.isSignatureRequired&&this.data?.isUserSignRequired)}get signatureDisplay(){return this.data?.isUploadDocumentVersion&&this.data?.isSignatureRequired||this.userAlreadySigned}createPerformDocumentWorkflow(){this.isLoading=!0;let e=null;if(this.data.isSignatureRequired||this.data.isUploadDocumentVersion){if(this.signatureDisplay&&(this.signaturePad&&!this.signaturePad.isEmpty()?e=this.signaturePad.toDataURL():this.uploadedSignature&&(e=this.uploadedSignature),!e||e==="data:image/png;base64,"||e==="data:image/jpeg;base64,")){this.toastrService.error(this.translationService.getValue("PLEASE_PROVIDE_SIGNATURE")),this.isLoading=!1;return}if(!this.performDocumentWorkflowForm.valid){this.performDocumentWorkflowForm.markAllAsTouched(),this.isLoading=!1;return}this.data.isUploadDocumentVersion?this.saveDocument():this.performDocumentWorkflow()}}saveDocument(){let e=this.commonService.getInternetSpeed();if(this.fileData.size>this.chunkSize)this.saveDocumentChunk();else{let t={documentId:this.data.documentId,url:this.fileData.name,file:this.fileData,extension:this.extension,comment:""};this.documentService.saveNewVersionDocument(t).subscribe({next:i=>{this.documentVersionId=i.id??"",this.documentStore.loadDocuments(),this.foldersViewStore.selectedCategoryId()==i.categoryId&&(this.foldersViewStore.setDocumentsEmpty(),this.foldersViewStore.loadDocumentsByCategory(this.foldersViewStore.selectedCategoryId())),this.performDocumentWorkflow()},error:i=>{this.isLoading=!1}})}}saveDocumentChunk(){let e={documentId:this.data.documentId,url:this.fileData.name,extension:this.extension,comment:""};this.documentService.saveNewVersionDocumentChunk(e).subscribe({next:t=>{this.document=t,this.documentVersionId=t.id??"",this.uploadFileInChunks(t.id??"")},error:t=>{this.isLoading=!1}})}uploadFileInChunks(e){if(!this.fileData)return;let{chunkSize1:t,parallelCalls:i}=this.commonService.getNetworkSpeed(),r=Math.ceil(this.fileData.size/this.chunkSize),f=[];this.progress=0;for(let m=0;m<r;m++){let S=m*this.chunkSize,u=Math.min(S+this.chunkSize,this.fileData.size),D=this.fileData.slice(S,u),g=new FormData;g.append("file",D),g.append("chunkIndex",m.toString()),g.append("size",this.chunkSize.toString()),g.append("totalChunks",r.toString()),g.append("extension",this.extension),g.append("documentVersionId",e),f.push(g)}this.sub$.sink=P(f).pipe(U(i),A(m=>P(m).pipe(L(()=>console.log("Processing batch:",m)),M(S=>this.uploadChunk(S),i)))).subscribe({next:m=>{this.progress=Math.min(this.progress+100/r,100),this.cd.markForCheck()},complete:()=>{this.progress=100,this.isLoading=!1,this.markChunkAsUploaded(),this.toastrService.success(this.translationService.getValue("DOCUMENT_SAVE_SUCCESSFULLY")),this.cd.markForCheck()},error:m=>{this.markChunkAsUploaded(!1),this.isLoading=!1,this.cd.markForCheck()}})}uploadChunk(e){return this.documentService.uploadChunkDocument(e)}markChunkAsUploaded(e=!0){this.isLoading=!0,this.commonService.markChunkAsUploaded(this.documentVersionId,e).subscribe({next:t=>{this.isLoading=!1,this.documentStore.loadDocuments(),this.foldersViewStore.selectedCategoryId()==this.document.categoryId&&(this.foldersViewStore.setDocumentsEmpty(),this.foldersViewStore.loadDocumentsByCategory(this.foldersViewStore.selectedCategoryId())),this.performDocumentWorkflow()},error:t=>{this.isLoading=!1}})}performDocumentWorkflow(){this.isLoading=!0;let e=this.buidPerformDocumentWorkflow();this.mode="indeterminate",this.workflowInstanceService.performNextTransitionWithDocumentAndSignature(e).subscribe({next:t=>{this.isLoading=!1,t&&(this.toastrService.success(`${this.data.transitionName} ${this.translationService.getValue("HAS_BEEN_SUCCESSFULLY_COMPLETED")}`),this.dialogRef.close(!0))},error:t=>{this.isLoading=!1}})}onClear(){this.signaturePad.clear()}buidPerformDocumentWorkflow(){return{workflowInstanceId:this.data.workflowInstanceId,transitionId:this.data.transitionId,workflowStepInstanceId:this.data.workflowStepInstanceId,isUploadDocumentVersion:this.data.isUploadDocumentVersion??!1,isSignatureRequired:this.data.isSignatureRequired??!1,comment:this.performDocumentWorkflowForm.get("comment")?.value,url:this.fileData,extension:this.extension,signature:this.data.isSignatureRequired?this.uploadedSignature?this.uploadedSignature:this.signaturePad.toDataURL():"",documentVersionId:this.documentVersionId?this.documentVersionId:"",documentId:this.data.documentId??""}}closeDialog(){this.dialogRef.close(!1)}onFileSelected(e){let i=e.target.files?.[0];if(!i)return;if(i.type!=="image/png"&&i.type!=="image/jpeg"){this.toastrService.error(this.translationService.getValue("INVALID_FILE_TYPE"));return}let r=new FileReader;r.onload=()=>{let f=new Image;f.src=r.result,f.onload=()=>{let m=this.canvasRef.nativeElement;if(!m.getContext("2d"))return;let u=document.createElement("canvas");u.width=m.width,u.height=m.height;let D=u.getContext("2d");D&&(D.clearRect(0,0,u.width,u.height),D.drawImage(f,0,0,u.width,u.height),this.uploadedSignature=u.toDataURL(i.type==="image/jpeg"?"image/jpeg":"image/png"),this.signaturePad.clear())}},r.readAsDataURL(i)}static \u0275fac=function(t){return new(t||s)(p(H),p(ve),p(Q),p(q),p(re),p(se),p(Ie),p(ae),p(De))};static \u0275cmp=O({type:s,selectors:[["app-perform-transition"]],viewQuery:function(t,i){if(t&1&&N(Ee,5),t&2){let r;B(r=j())&&(i.canvasRef=r.first)}},features:[W],decls:32,vars:16,consts:[["file",""],["canvas",""],[1,"d-flex"],[1,"me-auto","p-2"],[1,"mb-3","page-title"],["code","REQUEST_DOCUMENT_THROUGH_WORKFLOW"],[1,"d-flex","justify-content-end","mb-2"],[1,"close-icon","text-danger","cursor-pointer",3,"click"],[3,"formGroup"],[1,"row"],[1,"col-sm-12","mt-2"],[1,"form-label"],["formControlName","comment","name","comment",1,"form-control"],[1,"row","mt-2"],[1,"col-md-12"],["matButton","filled",1,"success","me-2",3,"click"],[1,"medium-icon"],["type","button","matButton","filled",1,"error",3,"click"],[1,"spinner-container"],[1,"col-sm-12"],[1,"form-group"],["type","file",1,"form-control",3,"change"],[1,"text-danger"],["for","signature",1,"form-label","text-danger"],[1,"signature-container","bg-white"],["for","or",1,"text-danger","d-flex","justify-content-center","align-items-center","m-2","w-100"],["for","signature"],["type","file","accept","image/png, image/jpeg",1,"form-control","signature-upload",3,"change"],[1,"mt-2","col-md-12"],[1,"medium-icon","align-middle"],["diameter","60","strokeWidth","5",1,"example-margin",3,"mode","value"]],template:function(t,i){t&1&&(o(0,"mat-dialog-content")(1,"div",2)(2,"div",3)(3,"span",4),l(4),c(5,"translate"),I(6,"app-page-help-text",5),n()(),o(7,"div",6)(8,"mat-icon",7),v("click",function(){return i.closeDialog()}),l(9,"cancel"),n()()(),o(10,"div",8),x(11,Pe,10,5,"div",9),x(12,be,25,12,"div",9),o(13,"div",9)(14,"div",10)(15,"label",11),l(16),c(17,"translate"),n(),I(18,"textarea",12),n()(),o(19,"div",13)(20,"div",14)(21,"button",15),v("click",function(){return i.createPerformDocumentWorkflow()}),o(22,"mat-icon",16),l(23,"save"),n(),l(24),c(25,"translate"),n(),o(26,"button",17),v("click",function(){return i.closeDialog()}),o(27,"mat-icon",16),l(28,"cancel"),n(),l(29),c(30,"translate"),n()()()(),x(31,Fe,2,2,"div",18),n()),t&2&&(a(4),h(" ",d(5,8,"REQUEST_DOCUMENT_THROUGH_WORKFLOW")," "),a(6),b("formGroup",i.performDocumentWorkflowForm),a(),C(i.data.isUploadDocumentVersion?11:-1),a(),C(i.signatureDisplay?12:-1),a(4),V(d(17,10,"REMARK")),a(8),h(" ",d(25,12,"SAVE")," "),a(5),h(" ",d(30,14,"CANCEL")," "),a(2),C(i.isLoading?31:-1))},dependencies:[$,Y,Se,ue,pe,fe,he,ge,de,ce,G,te,Ce,Z,J,xe,X,K,ee],styles:[".signature-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center}.signature-container[_ngcontent-%COMP%]   canvas[_ngcontent-%COMP%]{border:1px solid #ccc;width:100%;max-width:60vw;max-height:70vh}.signature-container[_ngcontent-%COMP%]   .controls[_ngcontent-%COMP%]{margin-top:10px;display:flex;gap:10px}"]})};export{ke as a};
