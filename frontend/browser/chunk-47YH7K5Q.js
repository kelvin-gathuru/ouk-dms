import{a as Ce}from"./chunk-W6Y3OYFO.js";import{a as _e}from"./chunk-DP5AXSVW.js";import{a as ae}from"./chunk-E4NKSOB7.js";import{a as ue}from"./chunk-D6HICPES.js";import{b as re}from"./chunk-ZPADZQPI.js";import{c as le}from"./chunk-2OJALU77.js";import{a as ne}from"./chunk-APWCXNU6.js";import{a as Z}from"./chunk-6GBRFDEJ.js";import{a as me,b as ce}from"./chunk-YCBFVA3Y.js";import{a as ee}from"./chunk-ZXWR2MAY.js";import{c as pe}from"./chunk-PJSVLHWR.js";import{a as se}from"./chunk-546GNQSA.js";import{b as $,c as W,d as G,e as Y,f as q}from"./chunk-2DXU6Z77.js";import{b as ie}from"./chunk-WC3ZMFX5.js";import{b as oe}from"./chunk-UFOTACYY.js";import{a as te}from"./chunk-RKRBEXQJ.js";import{e as de}from"./chunk-F3ENXN4Q.js";import{a as J,b as K}from"./chunk-P6E4AR6Q.js";import{va as z}from"./chunk-GDJX5AXE.js";import{$ as _,Ca as f,Da as D,Db as p,Ea as F,Eb as h,Ec as j,Fb as V,Ga as L,Ha as U,Ia as y,Ja as n,Ka as r,La as I,Pa as k,Pc as Q,Qa as O,Rc as X,Sa as x,Ua as S,W as a,Wa as l,ga as A,i as E,jb as m,ka as B,kb as C,lb as b,ma as w,mb as P,p as v,q as g}from"./chunk-KZMFGXDY.js";import{I as T,Ja as H,_ as N,za as M}from"./chunk-W3TJXGK4.js";import{p as R}from"./chunk-H5HZ6YB3.js";function fe(i,d){if(i&1&&m(0),i&2){let e=l().$implicit;b(" ",e.signBy," ")}}function De(i,d){if(i&1&&(m(0),p(1,"utcToLocalTime")),i&2){let e=l().$implicit;b(" ",V(1,1,e.signDate,"short")," ")}}function Se(i,d){if(i&1){let e=x();n(0,"span",11),S("click",function(){v(e);let t=l().$implicit,s=l();return g(s.showComment(t.comment))}),n(1,"mat-icon"),m(2," chat"),r()()}}function ve(i,d){i&1&&(n(0,"span",10),m(1),p(2,"translate"),r()),i&2&&(a(),b("",h(2,1,"CURRENT_VERSION")," "))}function ge(i,d){if(i&1){let e=x();k(0),n(1,"span",14),S("click",function(){v(e);let t=l(3).$implicit,s=l();return g(s.downloadDocument(t))}),n(2,"mat-icon"),m(3," download"),r()(),O()}}function xe(i,d){if(i&1){let e=x();k(0),n(1,"span",15),S("click",function(){v(e);let t=l(3).$implicit,s=l();return g(s.restoreDocumentVersion(t))}),n(2,"mat-icon"),m(3," restore"),r()(),O()}}function ye(i,d){i&1&&w(0,ge,4,0,"ng-container",13)(1,xe,4,0,"ng-container",13),i&2&&(y("hasClaim","ALL_DOWNLOAD_DOCUMENT"),a(),y("hasClaim","ALL_RESTORE_VERSION"))}function be(i,d){if(i&1){let e=x();n(0,"span",14),S("click",function(){v(e);let t=l(3).$implicit,s=l();return g(s.downloadDocument(t))}),n(1,"mat-icon"),m(2," download"),r()()}}function Ve(i,d){if(i&1){let e=x();n(0,"span",15),S("click",function(){v(e);let t=l(3).$implicit,s=l();return g(s.restoreDocumentVersion(t))}),n(1,"mat-icon"),m(2," restore"),r()()}}function Te(i,d){i&1&&w(0,be,3,0,"span",16)(1,Ve,3,0,"span",17),i&2&&(y("hasClaim","ASSIGNED_DOWNLOAD_DOCUMENT"),a(),y("hasClaim","ASSIGNED_RESTORE_VERSION"))}function Ee(i,d){if(i&1){let e=x();n(0,"div")(1,"span",12),S("click",function(){v(e);let t=l().$implicit,s=l();return g(s.onDocumentView(t))}),n(2,"mat-icon"),m(3," visibility"),r()(),f(4,ye,2,2),f(5,Te,2,2),r()}if(i&2){let e=l(2);a(4),D(e.data.isAssignUser?-1:4),a(),D(e.data.isAssignUser?5:-1)}}function we(i,d){if(i&1&&(n(0,"tr")(1,"td"),m(2),r(),n(3,"td"),m(4),p(5,"utcToLocalTime"),r(),n(6,"td"),m(7),r(),n(8,"td"),f(9,fe,1,1),r(),n(10,"td"),f(11,De,2,4),r(),n(12,"td"),f(13,Se,3,0,"span",9),r(),n(14,"td"),f(15,ve,3,3,"span",10)(16,Ee,6,2,"div"),r()()),i&2){let e=d.$implicit;a(2),C(e.versionNumber),a(2),C(V(5,7,e.modifiedDate,"full")),a(3),b(" ",e.createdByUser," "),a(2),D(e.signBy?9:-1),a(2),D(e.signBy?11:-1),a(2),D(e.comment?13:-1),a(2),D(e.isCurrentVersion?15:16)}}function Ie(i,d){i&1&&(n(0,"div",8),I(1,"mat-progress-spinner",18),r())}var he=class i extends ee{constructor(e,o,t,s,c,u,ke,Oe,Re){super();this.data=e;this.overlay=o;this.dialogRef=t;this.toastrService=s;this.documentService=c;this.commonService=u;this.securityService=ke;this.dialog=Oe;this.commandDialogService=Re}isLoadingResults=!1;documentVersions=[];documentUrl;documentChunks=[];contentType="";documentChunkDownloads=[];isLoading=!1;documentStore=E(re);foldersViewStore=E(ae);progress=0;ngOnInit(){}closeDialog(){this.dialogRef.close()}onDocumentView(e){return R(this,null,function*(){try{let o={documentId:this.data.id,name:this.data.name,extension:e.extension,isVersion:!0,id:this.data.id,isFromPublicPreview:!1,isPreviewDownloadEnabled:this.securityService.hasClaim("ALL_DOWNLOAD_DOCUMENT"),isFileRequestDocument:!1,isSignatureExists:e.isSignatureExists,url:e.url,comment:e.comment,documentVersionId:e.id,isChunk:e.isChunk,documentNumber:this.data.documentNumber},{BasePreviewComponent:t}=yield import("./chunk-BJ7BM7KC.js");this.overlay.open(t,{position:"center",origin:"global",panelClass:["file-preview-overlay-container","white-background"],data:o})}finally{this.isLoadingResults=!1}})}restoreDocumentVersion(e){this.sub$.sink=this.commandDialogService.deleteConfirmtionDialog(this.translationService.getValue("ARE_YOU_SURE_YOU_WANT_TO_RESTORE_THIS_TO_CURRENT_VERSION")).subscribe(o=>{o&&(this.sub$.sink=this.documentService.restoreDocumentVersion(this.data.id??"",e.id??"").subscribe(()=>{this.toastrService.success(this.translationService.getValue("VERSION_RESTORED_SUCCESSFULLY")),this.addDocumentTrail(this.data.id??"",13 .toString()),this.documentStore.loadDocuments(),this.foldersViewStore.selectedCategoryId()==this.data.categoryId&&(this.foldersViewStore.setDocumentsEmpty(),this.foldersViewStore.loadDocumentsByCategory(this.foldersViewStore.selectedCategoryId())),this.dialogRef.close(!0)}))})}downloadDocument(e){if(e.isChunk)this.getAllDocumentChunks(e.id??"");else{let o={documentId:this.data.id,name:"",extension:e.url?.split(".")[1],isVersion:!0,isFromPublicPreview:!1,isPreviewDownloadEnabled:!1,isFileRequestDocument:!1,isSignatureExists:!1,comment:e.comment,documentVersionId:e.id,documentNumber:this.data.documentNumber};this.sub$.sink=this.commonService.downloadDocument(o).subscribe({next:t=>{t.type===j.Response&&(this.addDocumentTrail(this.data.id??"",8 .toString()),t.body?(this.documentUrl=new Blob([t.body],{type:t.body.type}),this.downloadFile()):this.toastrService.error(this.translationService.getValue("ERROR_WHILE_DOWNLOADING_DOCUMENT")))},error:t=>{this.toastrService.error(this.translationService.getValue("ERROR_WHILE_DOWNLOADING_DOCUMENT"))}})}}getAllDocumentChunks(e){this.sub$.sink=this.commonService.getDocumentChunks(e).subscribe({next:o=>{this.documentChunks=o,this.documentChunks.length>0&&this.startDownload(e)},error:o=>{this.toastrService.error(o.error.message)}})}startDownload(e){this.isLoading=!0,this.progress=0;let{chunkSize1:o,parallelCalls:t}=this.commonService.getNetworkSpeed(),s=[];for(let c=0;c<this.documentChunks.length;c++)s.push({chunkIndex:c,documentVersionId:this.documentChunks[c].documentVersionId});this.sub$.sink=T(s).pipe(M(t),H(c=>T(c).pipe(N(u=>this.downloadChunk(u.chunkIndex,u.documentVersionId),t)))).subscribe({next:c=>{this.progress=Math.min(this.progress+100/s.length,100),this.contentType=c.contentType;let u=this.base64ToBlob(c.data,c.contentType);c.blobChunk=u,this.documentChunkDownloads.push(c)},complete:()=>this.mergeChunks(),error:c=>{this.progress=0,this.isLoading=!1,console.error("Error downloading chunks",c)}})}downloadChunk(e,o){return this.commonService.downloadDocumentChunk(o,e)}mergeChunks(){this.progress=100,this.isLoading=!1;let e=this.documentChunkDownloads.sort((t,s)=>t.chunkIndex-s.chunkIndex).map(t=>t.blobChunk).filter(t=>t!==void 0),o=new Blob(e,{type:this.contentType});this.documentUrl=o,this.downloadFile()}base64ToBlob(e,o){let t=atob(e),s=new Array(t.length);for(let u=0;u<t.length;u++)s[u]=t.charCodeAt(u);let c=new Uint8Array(s);return new Blob([c],{type:o})}addDocumentTrail(e,o){let t={documentId:e,operationName:o};this.documentStore.addDocumentAudit(t)}downloadFile(){let e=document.createElement("a");e.setAttribute("style","display:none;"),document.body.appendChild(e),e.download=this.data.name??"",e.href=URL.createObjectURL(this.documentUrl),e.target="_blank",e.click(),document.body.removeChild(e)}showComment(e){let o=this.dialog.open(Ce,{width:"800px",maxHeight:"70vh",data:e})}static \u0275fac=function(o){return new(o||i)(_(W),_(le),_($),_(ie),_(ne),_(oe),_(te),_(G),_(_e))};static \u0275cmp=A({type:i,selectors:[["app-document-version-history"]],features:[B],decls:40,vars:30,consts:[[1,"d-flex"],[1,"me-auto","p-2"],[1,"mb-3","page-title"],[3,"code"],[1,"d-flex","justify-content-end","mb-2"],[1,"close-icon","text-danger","cursor-pointer",3,"click"],[1,"table-responsive"],[1,"table","table-pos","table_color"],[1,"spinner-container"],["role","button","matTooltip","Comment",1,"me-2","text-primary"],[1,"badge","bg-success"],["role","button","matTooltip","Comment",1,"me-2","text-primary",3,"click"],["matTooltip","view","role","button",1,"material-icons-outlined","me-2","text-primary",3,"click"],[4,"hasClaim"],["role","button","matTooltip","Download",1,"me-2","text-primary",3,"click"],["role","button","matTooltip","Restore to Current Version",1,"material-icons-outlined","text-primary",3,"click"],["role","button","class","me-2 text-primary","matTooltip","Download",3,"click",4,"hasClaim"],["role","button","matTooltip","Restore to Current Version","class","material-icons-outlined text-primary",3,"click",4,"hasClaim"],["mode","indeterminate","diameter","60","strokeWidth","5"]],template:function(o,t){o&1&&(n(0,"mat-dialog-content")(1,"div",0)(2,"div",1)(3,"span",2),m(4),p(5,"limitTo"),p(6,"translate"),I(7,"app-page-help-text",3),r()(),n(8,"div",4)(9,"mat-icon",5),S("click",function(){return t.closeDialog()}),m(10,"cancel"),r()()(),n(11,"div",6)(12,"table",7)(13,"thead")(14,"tr")(15,"th"),m(16),p(17,"translate"),r(),n(18,"th"),m(19),p(20,"translate"),r(),n(21,"th"),m(22),p(23,"translate"),r(),n(24,"th"),m(25),p(26,"translate"),r(),n(27,"th"),m(28),p(29,"translate"),r(),n(30,"th"),m(31),p(32,"translate"),r(),n(33,"th"),m(34),p(35,"translate"),r()()(),n(36,"tbody"),L(37,we,17,10,"tr",null,F),r()()(),f(39,Ie,2,0,"div",8),r()),o&2&&(a(4),P(" ",V(5,11,t.data.name,"10"),"'s ",h(6,14,"VERSION_HISTORY")," "),a(3),y("code","VERSION_HISTORY"),a(9),C(h(17,16,"VERSION_NO")),a(3),C(h(20,18,"MODIFIED_DATE")),a(3),C(h(23,20,"CREATED_BY")),a(3),C(h(26,22,"SIGNBY")),a(3),C(h(29,24,"SIGNDATE")),a(3),C(h(32,26,"COMMENT")),a(3),C(h(35,28,"ACTIONS")),a(3),U(t.data.documentVersions),a(2),D(t.isLoading||t.isLoadingResults?39:-1))},dependencies:[pe,se,q,Y,ce,me,K,J,X,z,de,Q,ue,Z],styles:[".table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]{border-bottom:none}"]})};export{he as a};
