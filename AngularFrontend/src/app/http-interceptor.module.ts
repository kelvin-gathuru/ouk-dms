import { EnvironmentInjector, inject, Injectable, runInInjectionContext } from '@angular/core';
import { Observable, of, throwError, timer } from 'rxjs';
import {
  HttpEvent,
  HttpRequest,
  HttpErrorResponse,
  HttpHandlerFn,
  HttpInterceptorFn,
} from '@angular/common/http';
import { environment } from '@environments/environment';
import { catchError, finalize } from 'rxjs/operators';
import { Router } from '@angular/router';

import { ToastrService } from '@core/services/toastr-service';
import { TranslationService } from '@core/services/translation.service';
import { LoadingService } from '@shared/loading-indicator/loading-service';

export const HttpRequestInterceptor: HttpInterceptorFn = (
  req: HttpRequest<unknown>,
  next: HttpHandlerFn,

): Observable<HttpEvent<unknown>> => {
  const baseUrl = environment.apiUrl;
  const envInjector = inject(EnvironmentInjector);
  const loadingService = inject(LoadingService);
  loadingService.startRequest();

  if (req.url.lastIndexOf('i18n') > -1) {
    return next(req).pipe(
      finalize(() => loadingService.endRequest())
    );
  }

  // Get token from local storage directly
  let token = null;
  const authUser = localStorage.getItem('auth_user');
  if (authUser) {
    try {
      const user = JSON.parse(authUser);
      token = user.bearerToken;
    } catch (e) {
      console.error('Error parsing auth_user for token', e);
    }
  }

  const url = req.url.lastIndexOf('api') > -1 ? req.url : 'api/' + req.url;
  let newReq: HttpRequest<any>;
  if (token) {
    newReq = req.clone({
      headers: req.headers.set('Authorization', 'Bearer ' + token),
      url: `${baseUrl}${url}`,
    });
  } else {
    newReq = req.clone({
      url: `${baseUrl}${url}`,
    });
  }
  return next(newReq)
    .pipe(
      catchError((err: HttpErrorResponse) => {
        if (err instanceof HttpErrorResponse) {
          runInInjectionContext(envInjector, () => {
            const router = inject(Router);
            const toastrService = inject(ToastrService);
            const translationService = inject(TranslationService);

            if (err.status === 401) {
              router.navigate(['login']);
            } else if (err.status === 403) {
              toastrService.error(
                translationService.getValue('ACCESS_FORBIDDEN')
              );
            } else if (err.error && err.error.length >= 0) {
              toastrService.error(err.error[0]);
            } else if (err.error && err.error?.messages?.length > 0) {
              toastrService.error(err?.error?.messages[0]);
            }
          })
        }
        return throwError(() => err);
      }),
      finalize(() => loadingService.endRequest())
    );
}



