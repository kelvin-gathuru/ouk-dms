<section class="content">
  <div class="container-fluid">
    <div class="d-flex mb-2">
      <div class="me-auto">
        <span class="mb-0 page-title">
          {{ "ASSIGNED_WORKFLOWS" | translate }}
          <app-page-help-text code="CURRENT_WORKFLOWS"></app-page-help-text>
        </span>
      </div>
    </div>

    <mat-card appearance="outlined">
      <mat-card-content>
        @if (workflowInstances.length === 0) {
        <div class="text-left">
          <h6 class="text-muted">{{ "NO_WORKFLOW_ASSIGNED" | translate }}</h6>
        </div>
        } @else {
        @for(workflowinstance of workflowInstances; track $index; let i = $index) {
        <div class="card p-2 mb-1" style="border: 1px solid #d3d4d6;">
          <div class="card-header">
            <span class="fw-bold">
              {{i + 1}} {{')'}} &nbsp; {{ "WORKFLOW_NAME" | translate }} - {{ workflowinstance?.workflowName }}
            </span>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-sm-4">
                <div class="form-group">
                  <label class="fw-bold"> {{ "DOCUMENT" | translate }}</label>
                  <a class="doc-link form-control-plaintext form-control-sm" (click)="onDocumentView(workflowinstance)">
                    {{ workflowinstance?.documentNumber }} - {{ workflowinstance?.documentName }}
                  </a>
                </div>
              </div>
              <div class="col-sm-2">
                <div class="form-group">
                  <label class="fw-bold"> {{ "WORKFLOW_STATUS" | translate }}</label>
                  <span class="form-control-plaintext form-control-sm"
                    [workflowstatuscolor]="workflowinstance.workflowInstanceStatus">
                    {{ workflowinstance?.workflowInstanceStatus | workflowInstanceStatus }}
                  </span>
                </div>
              </div>
              <div class="col-sm-3">
                <div class="form-group">
                  <label class="fw-bold"> {{ "INITIATED_BY" | translate }}</label>
                  <span class="form-control-plaintext form-control-sm">
                    {{ workflowinstance?.initiatedUser }}
                  </span>
                </div>
              </div>
              <div class="col-sm-3">
                <div class="form-group">
                  <label class="fw-bold"> {{ "WORKFLOW_INITIATED_AT" |
                    translate
                    }}
                  </label>
                  <span class="form-control-plaintext form-control-sm">
                    {{ workflowinstance?.workflowInitiatedDate | utcToLocalTime : "short" }}
                  </span>
                </div>
              </div>
            </div>
            @if (workflowinstance?.lastTransition) {
            <div class="row">
              <div class="col-sm-4">
                <div class="form-group">
                  <label class="fw-bold"> {{ "LAST_PERFORM_TRANSITION" | translate }}</label>
                  <span class="form-control-plaintext form-control-sm">
                    {{ workflowinstance?.lastTransition }}({{ workflowinstance?.lastTransitionSteps}})
                  </span>
                </div>
              </div>
              <div class="col-sm-2">
                <div class="form-group">
                  <label class="fw-bold"> {{ "UPDATEDAT" | translate }}</label>
                  <span class="form-control-plaintext form-control-sm">
                    {{ workflowinstance?.updatedAt | utcToLocalTime : "short" }}
                  </span>
                </div>
              </div>
              @if(workflowinstance?.performBy){
              <div class="col-sm-3">
                <div class="form-group">
                  <label class="fw-bold"> {{ "PERFORM_BY" | translate }}</label>
                  <span class="form-control-plaintext form-control-sm">
                    {{ workflowinstance?.performBy }}
                  </span>
                </div>
              </div>
              }
              @if(workflowinstance?.lastTransitionComment) {
              <div class="col-sm-3">
                <div class="form-group">
                  <label class="fw-bold"> {{ "LAST_TRANSITION_COMMENT" | translate }}</label>
                  <span class="form-control-plaintext form-control-sm">
                    {{ workflowinstance?.lastTransitionComment }}
                  </span>
                </div>
              </div>
              }
            </div>
            }
            <div class="row">
              <div class="col">
                <div class="form-group">
                  <label class="fw-bold"> {{ "PERFORM_TRANSITION" | translate }}</label>
                  <div class="d-flex flex-column flex-md-row gap-2">
                    <button matMiniFab matTooltip="{{'VIEW_WORKFLOW_DETAIL' | translate}}"
                      [matTooltipPosition]="positionOptions[0]" class="primary"
                      (click)="viewVisualWorkflow(workflowinstance)">
                      <mat-icon class="medium-icon fs-5 align-middle">visibility</mat-icon>
                    </button>
                    @if (workflowinstance.workflowInstanceStatus !== WorkflowInstanceStatus.Cancelled) {
                    @for (transition of workflowinstance.workflowTransitions; track $index) {
                    @if (transition.allowRoleToPerformTransition || transition.allowUserToPerformTransition) {
                    <button matTooltip="{{transition?.comment}}" [matTooltipPosition]="positionOptions[0]"
                      (click)="performTransition(transition, workflowinstance)"
                      [ngClass]="'workflow_' + transition.color" class="btn btn-sm mb-1 mt-1">
                      {{ transition.name }} ({{ transition.fromToStepName }})
                    </button>
                    }
                    }
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        }
        }
      </mat-card-content>
    </mat-card>
  </div>
</section>
@if(isLoadingResults) {
<div class="spinner-container">
  <!-- <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div> -->
  <mat-progress-spinner mode="indeterminate" diameter="60" strokeWidth="5">
  </mat-progress-spinner>
</div>
}
