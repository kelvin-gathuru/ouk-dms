<section class="content">
  <div class="container-fluid">
    <div class="d-flex mb-2">
      <div class="me-auto">
        <span class="mb-0 page-title"
          >{{ "DOCUMENTS_AUDIT_TRAIL" | translate }}
          <app-page-help-text
            [code]="'DOCUMENTS_AUDIT_TRAIL'"
          ></app-page-help-text>
        </span>
      </div>
    </div>
    <mat-card appearance="outlined">
      <mat-card-content>
        <mat-accordion>
          <mat-expansion-panel [expanded]="step() === 0">
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{ "FILTER" | translate }}
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="d-flex flex-wrap flex-column flex-sm-row">
              <div class="p-1 flex-item flex-fill">
                <input
                  class="form-control"
                  placeholder="{{ 'DOCUMENT_NO' | translate }}"
                  #docNoInput
                />
              </div>
              <div class="p-1 flex-item flex-fill">
                <input
                  class="form-control"
                  placeholder="{{ 'SEARCH_DOCUMENT_BY_NAME' | translate }}"
                  #input
                />
              </div>
              <div class="p-1 flex-item flex-fill">
                <mat-select
                  panelClass="mat-select-control"
                  class="form-control"
                  [(value)]="selectedCategory"
                  placeholder="{{ 'SELECT_CATEGORY' | translate }}"
                  (selectionChange)="onCategoryChange($event)"
                >
                  <mat-select-trigger>
                    {{ selectedCategory?.displayName ?? "NONE" | translate }}
                  </mat-select-trigger>
                  <mat-option [value]=""
                    >-- {{ "NONE" | translate }} --</mat-option
                  >
                  @for(category of allCategories; track category.id) {
                  <mat-option [value]="category">
                    <div
                      class="country-item"
                      [ngStyle]="{
                        'margin-left.px': (category.deafLevel ?? 0) * 20
                      }"
                    >
                      @if(category.deafLevel == 0) {
                      <div class="d-flex align-items-center">
                        <mat-icon class="text-warning me-1">folder</mat-icon>
                        <b>{{ category.name }}</b>
                      </div>
                      } @else {
                      <div
                        [matTooltip]="category.name"
                        class="d-flex align-items-center"
                      >
                        <mat-icon class="text-warning me-1">folder</mat-icon>
                        {{ category.name }}
                      </div>
                      }
                    </div>
                  </mat-option>
                  }
                </mat-select>
              </div>
              <div class="p-1 flex-item flex-fill">
                <mat-select
                  panelClass="mat-select-control"
                  class="form-control"
                  placeholder="{{ 'SELECT_OPERATION' | translate }}"
                  (selectionChange)="onOperationChange($event)"
                >
                  <mat-option [value]=""
                    >-- {{ "NONE" | translate }} --</mat-option
                  >
                  @for(operation of operations ; track operation.value) {
                  <mat-option [value]="operation.value">
                    {{ operation.key }}
                  </mat-option>
                  }
                </mat-select>
              </div>
              <div class="p-1 flex-item flex-fill">
                <mat-select
                  panelClass="mat-select-control"
                  class="form-control"
                  placeholder="{{ 'SELECT_USER' | translate }}"
                  (selectionChange)="onUserChange($event)"
                >
                  <mat-option [value]=""
                    >-- {{ "NONE" | translate }} --</mat-option
                  >
                  @for(user of userStore.users(); track user.id) {
                  <mat-option [value]="user.id">
                    {{ user.firstName }} {{ user.lastName }}
                  </mat-option>
                  }
                </mat-select>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
        <div class="table-responsive mt-2">
          <div [ngClass]="{ 'grid-height-medium': step() === 0 }">
            <table
              mat-table
              [dataSource]="dataSource"
              class="w-100"
              matSort
              matSortActive="createdDate"
              matSortDirection="desc"
            >
              <ng-container matColumnDef="createdDate">
                <th
                  class="table-column-fix-200"
                  mat-header-cell
                  *matHeaderCellDef
                  mat-sort-header
                >
                  {{ "ACTION" | translate }} {{ "DATE" | translate }}
                </th>
                <td mat-cell *matCellDef="let document">
                  {{ document?.createdDate | utcToLocalTime : "full" }}
                </td>
              </ng-container>
              <ng-container matColumnDef="documentNumber">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ "DOCUMENT_NO" | translate }}
                </th>
                <td mat-cell *matCellDef="let document">
                  @if(document.isDocumentDeleted === false) {
                  <a class="doc-link" (click)="onDocumentView(document)">{{
                    document.documentNumber
                  }}</a>
                  } @else {
                  {{ document.documentNumber }}
                  }
                </td>
              </ng-container>
              <ng-container matColumnDef="documentName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ "NAME" | translate }}
                </th>
                <td mat-cell *matCellDef="let document">
                  @if(document.isDocumentDeleted === false) {
                  <a class="doc-link" (click)="onDocumentView(document)">{{
                    document.documentName
                  }}</a>
                  } @else {
                  {{ document.documentName }}
                  }
                </td>
              </ng-container>
              <ng-container matColumnDef="categoryName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ "CATEGORY_NAME" | translate }}
                </th>
                <td mat-cell *matCellDef="let document">
                  {{ document.categoryName }}
                </td>
              </ng-container>
              <ng-container matColumnDef="operationName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ "OPERATION" | translate }}
                </th>
                <td
                  mat-cell
                  *matCellDef="let document"
                  [appDocumentOperationColor]="document.operationName"
                >
                  {{ document.operationName.toUpperCase() | translate }}
                </td>
              </ng-container>
              <ng-container matColumnDef="createdBy">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ "BY_WHOM" | translate }}
                </th>
                <td mat-cell *matCellDef="let document">
                  {{ document?.createdBy }}
                </td>
              </ng-container>
              <ng-container matColumnDef="permissionUser">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ "TO_WHOM_USER" | translate }}
                </th>
                <td mat-cell *matCellDef="let document">
                  {{ document?.permissionUser }}
                </td>
              </ng-container>
              <ng-container matColumnDef="permissionRole">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ "TO_WHOM_ROLE" | translate }}
                </th>
                <td mat-cell *matCellDef="let document">
                  {{ document?.permissionRole }}
                </td>
              </ng-container>
              <ng-container matColumnDef="footer">
                <td mat-footer-cell colspan="8" *matFooterCellDef>
                  <mat-paginator
                    [length]="documentResource.totalCount"
                    [pageSize]="documentResource.pageSize"
                    [pageSizeOptions]="[10, 20, 30]"
                  >
                  </mat-paginator>
                </td>
              </ng-container>
              <tr
                class="grid-header-color"
                mat-header-row
                *matHeaderRowDef="displayedColumns; sticky: true"
              ></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              <tr
                mat-footer-row
                *matFooterRowDef="footerToDisplayed; sticky: true"
              ></tr>
              <tr *matNoDataRow>
                <td colspan="7">
                  <div class="m-2">
                    <b> {{ "NO_DATA_FOUND" | translate }}</b>
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</section>

@let loading =dataSource.loading$ | async; @if(loading || isLoadingResults){
<div class="spinner-container">
  <!-- <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div> -->
  <mat-progress-spinner mode="indeterminate" diameter="60" strokeWidth="5">
  </mat-progress-spinner>
</div>
}
