<section class="content">
  <div class="container-fluid">
    <div class="d-flex mb-2">
      <div class="me-auto">
        <span class="mb-0 page-title"
          >{{ "BULK_DOCUMENT_UPLOAD" | translate }}
          <app-page-help-text code="BULK_DOCUMENT_UPLOADS"></app-page-help-text>
        </span>
      </div>
    </div>
    <form [formGroup]="documentForm">
      <mat-card appearance="outlined">
        <mat-card-content>
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label [dir]="langDir" class="form-label text-danger"
                  >{{ "CATEGORY" | translate }} <sup>*</sup></label
                >
                <mat-select
                  [dir]="langDir"
                  panelClass="mat-select-control"
                  class="form-control"
                  formControlName="categoryId"
                  placeholder="{{ 'SELECT_CATEGORY' | translate }}"
                >
                  <mat-select-trigger>
                    <div class="d-flex align-items-center">
                      <mat-icon class="text-warning me-1">folder</mat-icon>
                      <span>
                        {{
                          getCategoryNameById(
                            documentForm.get("categoryId")?.value
                          ) || ("NONE" | translate)
                        }}
                      </span>
                    </div>
                  </mat-select-trigger>
                  <mat-option [value]=""
                    >-- {{ "NONE" | translate }} --</mat-option
                  >
                  @for(category of allCategories; track category.id) {
                  <mat-option [value]="category.id">
                    <div
                      class="country-item"
                      [ngStyle]="{
                        'margin-left.px': (category.deafLevel ?? 0) * 20
                      }"
                    >
                      @if(category.deafLevel == 0) {
                      <div class="d-flex align-items-center">
                        <mat-icon class="text-warning me-1">folder</mat-icon>
                        <b>{{ category.name }}</b>
                      </div>
                      } @else {
                      <div
                        [matTooltip]="category.name"
                        class="d-flex align-items-center"
                      >
                        <mat-icon class="text-warning me-1">folder</mat-icon>
                        {{ category.name }}
                      </div>
                      }
                    </div>
                  </mat-option>
                  }
                </mat-select>
                @if(documentForm.get('categoryId')?.touched &&
                documentForm.get('categoryId')?.errors &&
                documentForm.get('categoryId')?.errors?.['required']) {
                <div [dir]="langDir" class="text-danger">
                  {{ "CATEGORY_IS_REQUIRED" | translate }}
                </div>
                }
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label [dir]="langDir" class="form-label">{{
                  "DOCUMENT_STATUS" | translate
                }}</label>
                <mat-select
                  [dir]="langDir"
                  panelClass="mat-select-control"
                  class="form-control"
                  formControlName="documentStatusId"
                >
                  <mat-option>-- {{ "NONE" | translate }} --</mat-option>
                  @for(documentStatus of documentStatues; track
                  documentStatus.id) {
                  <mat-option [value]="documentStatus.id">
                    <span [ngStyle]="{ color: documentStatus?.colorCode }">
                      {{ documentStatus.name }}
                    </span>
                  </mat-option>
                  }
                </mat-select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label [dir]="langDir" class="form-label">{{
                  "STORAGE" | translate
                }}</label>
                <mat-select
                  [dir]="langDir"
                  panelClass="mat-select-control"
                  class="form-control"
                  formControlName="storageSettingId"
                >
                  @for(storageSetting of storageSettings; track
                  storageSetting.id) {
                  <mat-option [value]="storageSetting.id">
                    {{
                      storageSetting.storageType
                        | storageType : storageSetting.name
                    }}
                  </mat-option>
                  }
                </mat-select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label [dir]="langDir" class="form-label">{{
                  "CLIENT" | translate
                }}</label>
                <mat-select
                  [dir]="langDir"
                  panelClass="mat-select-control"
                  class="form-control"
                  formControlName="clientId"
                >
                  <mat-option>-- {{ "NONE" | translate }} --</mat-option>
                  @for(client of clientStore.clients(); track client.id) {
                  <mat-option [value]="client.id">
                    <span> {{ client.companyName }} </span>
                  </mat-option>
                  }
                </mat-select>
              </div>
            </div>
            <div class="col-md-4" *hasClaim="'ALL_SHARE_DOCUMENT'">
              <label [dir]="langDir" class="form-label">{{
                "ASSIGN_ROLES" | translate
              }}</label>
              <mat-select
                [dir]="langDir"
                panelClass="mat-select-control"
                class="form-control"
                placeholder="{{ 'ROLES' | translate }}"
                formControlName="selectedRoles"
                multiple
              >
                <mat-select-trigger>
                  @if(documentForm.get('selectedRoles')?.value?.length > 0) {
                  <span>
                    {{ documentForm.get("selectedRoles")?.value[0].name }}
                  </span>
                  } @if(documentForm.get('selectedRoles')?.value?.length > 1) {
                  <span class="example-additional-selection">
                    (+{{
                      documentForm.get("selectedRoles")?.value?.length - 1
                    }}
                    {{
                      documentForm.get("selectedRoles")?.value?.length === 2
                        ? "other"
                        : "others"
                    }})
                  </span>
                  }
                </mat-select-trigger>
                @for(role of roles; track role.id){
                <mat-option [value]="role">
                  {{ role.name }}
                </mat-option>
                }
              </mat-select>
              @if(documentForm.get('selectedRoles')?.value?.length > 0) {
              <div class="mt-3" formGroupName="rolePermissionForm">
                <mat-checkbox
                  [dir]="langDir"
                  color="primary"
                  formControlName="isTimeBound"
                >
                  {{ "SPACIFY_THE_PERIOD" | translate }}
                </mat-checkbox>
                @if(rolePermissionFormGroup.get('isTimeBound')?.value) {

                <div class="row">
                  <div class="col-md-6">
                    <div class="input-group">
                      <input
                        [dir]="langDir"
                        #ref
                        [min]="minDate"
                        class="form-control"
                        placeholder="{{ 'CHOOSE_A_START_DATE' | translate }}"
                        formControlName="startDate"
                        [matDatepicker]="startDatePicker"
                      />
                      <div class="input-group-append">
                        <button
                          [dir]="langDir"
                          class="btn btn-primary calendar-button"
                          type="button"
                          (click)="startDatePicker.open()"
                        >
                          <mat-icon class="medium-icon fs-5 align-middle"
                            >calendar_today</mat-icon
                          >
                        </button>
                      </div>
                    </div>
                    <mat-datepicker #startDatePicker></mat-datepicker>
                    @if(rolePermissionFormGroup.get('startDate')?.touched &&
                    rolePermissionFormGroup .get('startDate')
                    ?.hasError('required')){
                    <div class="text-danger">
                      {{ "START_DATE_IS_REQURED" | translate }}
                    </div>
                    }
                  </div>

                  <div class="col-md-6">
                    <div class="input-group">
                      <input
                        [dir]="langDir"
                        [min]="rolePermissionFormGroup.get('startDate')?.value"
                        class="form-control"
                        placeholder="{{ 'CHOOSE_A_END_DATE' | translate }}"
                        formControlName="endDate"
                        [matDatepicker]="endDatePicker"
                      />
                      <div class="input-group-append">
                        <button
                          [dir]="langDir"
                          class="btn btn-primary calendar-button"
                          type="button"
                          (click)="endDatePicker.open()"
                        >
                          <mat-icon class="medium-icon fs-5 align-middle"
                            >calendar_today</mat-icon
                          >
                        </button>
                      </div>
                    </div>
                    <mat-datepicker #endDatePicker></mat-datepicker>
                    @if(rolePermissionFormGroup.get('startDate')?.touched &&
                    rolePermissionFormGroup
                    .get('endDate')?.hasError('required')){
                    <div class="text-danger">
                      {{ "END_DATE_IS_REQURED" | translate }}
                    </div>
                    }
                  </div>
                </div>
                }
                <div>
                  <mat-checkbox
                    [dir]="langDir"
                    color="primary"
                    formControlName="isAllowDownload"
                    >{{ "ALLOW_DOWNLOAD" | translate }}
                  </mat-checkbox>
                </div>
              </div>
              }
            </div>
            <div class="col-md-4" *hasClaim="'ALL_SHARE_DOCUMENT'">
              <label [dir]="langDir" class="form-label">{{
                "ASSIGN_USERS" | translate
              }}</label>
              <mat-select
                [dir]="langDir"
                panelClass="mat-select-control"
                class="form-control"
                placeholder="{{ 'USERS' | translate }}"
                formControlName="selectedUsers"
                multiple
              >
                <mat-select-trigger>
                  @if(documentForm.get('selectedUsers')?.value?.length > 0){
                  <span>
                    {{ documentForm.get("selectedUsers")?.value[0]?.firstName }}
                    {{ documentForm.get("selectedUsers")?.value[0]?.lastName }}
                  </span>
                  } @if(documentForm.get('selectedUsers')?.value?.length > 1){
                  <span class="example-additional-selection">
                    (+{{
                      documentForm.get("selectedUsers")?.value?.length - 1
                    }}
                    {{
                      documentForm.get("selectedUsers")?.value?.length === 2
                        ? "other"
                        : "others"
                    }})
                  </span>
                  }
                </mat-select-trigger>
                @for(user of userStore.users(); track user.id) {
                <mat-option [value]="user">
                  {{ user.firstName }} {{ user.lastName }}
                </mat-option>
                }
              </mat-select>
              @if(documentForm.get('selectedUsers')?.value?.length > 0) {
              <div class="mt-3" formGroupName="userPermissionForm">
                <mat-checkbox
                  [dir]="langDir"
                  color="primary"
                  formControlName="isTimeBound"
                >
                  {{ "SPACIFY_THE_PERIOD" | translate }}
                </mat-checkbox>
                @if(userPermissionFormGroup.get('isTimeBound')?.value) {
                <div class="row">
                  <div class="col-md-6">
                    <div class="input-group">
                      <input
                        [dir]="langDir"
                        #ref
                        [min]="minDate"
                        class="form-control"
                        placeholder="{{ 'CHOOSE_A_START_DATE' | translate }}"
                        formControlName="startDate"
                        [matDatepicker]="startDatePicker"
                      />
                      <div class="input-group-append">
                        <button
                          [dir]="langDir"
                          class="btn btn-primary calendar-button"
                          type="button"
                          (click)="startDatePicker.open()"
                        >
                          <mat-icon class="medium-icon fs-5 align-middle"
                            >calendar_today</mat-icon
                          >
                        </button>
                      </div>
                    </div>
                    <mat-datepicker #startDatePicker></mat-datepicker>
                    @if(userPermissionFormGroup.get('startDate')?.touched &&
                    userPermissionFormGroup .get('startDate')
                    ?.hasError('required')){
                    <div [dir]="langDir" class="text-danger">
                      {{ "START_DATE_IS_REQURED" | translate }}
                    </div>
                    }
                  </div>
                  <div class="col-md-6">
                    <div class="input-group">
                      <input
                        [dir]="langDir"
                        [min]="userPermissionFormGroup.get('startDate')?.value"
                        class="form-control"
                        placeholder="{{ 'CHOOSE_A_END_DATE' | translate }}"
                        formControlName="endDate"
                        [matDatepicker]="endDatePicker"
                      />
                      <div class="input-group-append">
                        <button
                          [dir]="langDir"
                          class="btn btn-primary calendar-button"
                          type="button"
                          (click)="endDatePicker.open()"
                        >
                          <mat-icon class="medium-icon fs-5 align-middle"
                            >calendar_today</mat-icon
                          >
                        </button>
                      </div>
                    </div>
                    <mat-datepicker #endDatePicker></mat-datepicker>
                    @if(userPermissionFormGroup.get('startDate')?.touched &&
                    userPermissionFormGroup .get('endDate')
                    ?.hasError('required')){
                    <div [dir]="langDir" class="text-danger">
                      {{ "END_DATE_IS_REQURED" | translate }}
                    </div>
                    }
                  </div>
                </div>
                }
                <div>
                  <mat-checkbox
                    [dir]="langDir"
                    color="primary"
                    formControlName="isAllowDownload"
                    >{{ "ALLOW_DOWNLOAD" | translate }}</mat-checkbox
                  >
                </div>
              </div>
              }
            </div>
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label [dir]="langDir" class="form-label text-danger"
                    >{{ "DOCUMENT_UPLOAD" | translate }} <sup>*</sup></label
                  >
                  <input
                    [dir]="langDir"
                    class="form-control"
                    #file
                    (change)="onFileSelect($event)"
                    type="file"
                    multiple
                  />
                  @if(documentForm.get('files')?.touched &&
                  documentForm.get('files')?.value.length == 0){
                  <div [dir]="langDir" class="text-danger">
                    {{ "DOCUMENT_IS_REQUIRED" | translate }}
                  </div>
                  }
                </div>
              </div>
            </div>
          </div>
          <div class="row mt-4">
            <div class="col-md-12">
              <button
                [dir]="langDir"
                class="success me-2"
                matButton="filled"
                (click)="saveFilesAndDocument()"
                cdkFocusInitial
              >
                <mat-icon class="medium-icon">save</mat-icon>
                {{ "SAVE" | translate }}
              </button>
              <button
                [dir]="langDir"
                type="button"
                class="error"
                matButton="filled"
                [routerLink]="['/']"
              >
                <mat-icon class="medium-icon">cancel</mat-icon>
                {{ "CANCEL" | translate }}
              </button>
            </div>
          </div>
          <div class="row mt-3">
            @if(fileInputs.controls.length > 0){
            <div class="col-md-6">
              <ul formArrayName="files" class="list-group">
                @for(file of fileInputs.controls; let i = $index; track $index){
                <li
                  class="list-group-item d-flex justify-content-between align-items-center"
                >
                  <div class="row w-100" [formGroupName]="i">
                    <div class="col-md-6">
                      <div class="form-group">
                        <input
                          [dir]="langDir"
                          formControlName="name"
                          class="form-control"
                          type="text"
                          placeholder="{{ 'SELECTED_FILE_NAME' | translate }}"
                          [value]="file.get('name')?.value"
                        />
                      </div>
                      @if(file.get('name')?.touched && file.get('name')?.errors
                      && file.get('name')?.errors?.['required']){
                      <div [dir]="langDir" class="text-danger">
                        {{ "NAME_IS_REQUIRED" | translate }}
                      </div>
                      }
                    </div>
                    <div class="col-md-6">
                      <button
                        matMiniFab
                        [dir]="langDir"
                        class="error"
                        type="button"
                        (click)="removeFile(i)"
                      >
                        @if(file.get('isLoading')?.value){
                        <mat-icon class="medium-icon fs-5 align-middle"
                          >hourglass_empty</mat-icon
                        >
                        }@else{
                        <mat-icon class="medium-icon fs-5 align-middle"
                          >delete</mat-icon
                        >
                        }
                      </button>
                    </div>
                    @if(file.get('message')?.value){
                    <div class="col-md-12">
                      @if(file.get('isSuccess')?.value){
                      <span
                        [dir]="langDir"
                        class="badge bg-success rounded-pill"
                      >
                        {{ file.get("message")?.value }}
                      </span>
                      } @else{
                      <span
                        [dir]="langDir"
                        class="badge bg-danger rounded-pill"
                      >
                        {{ file.get("message")?.value }}
                      </span>
                      }
                    </div>
                    }
                  </div>
                </li>
                }
              </ul>
            </div>
            } @if(resultArray.length > 0){
            <div class="col-md-6">
              <ul class="list-group">
                @for(file of resultArray; let i = $index; track $index){
                <li
                  class="list-group-item d-flex justify-content-between align-items-center"
                >
                  <div class="row w-100">
                    <div [dir]="langDir" class="col-md-6">
                      <span>{{ file.name }}</span>
                    </div>
                    <div class="col-md-6">
                      @if(file.isSuccess){
                      <span
                        [dir]="langDir"
                        class="badge bg-success rounded-pill"
                      >
                        {{ file.message }}
                      </span>
                      } @else{
                      <span
                        [dir]="langDir"
                        class="badge bg-danger rounded-pill"
                      >
                        {{ file.message }}
                      </span>
                      }
                    </div>
                  </div>
                </li>
                }
              </ul>
            </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </form>
  </div>

  @if(isLoading){
  <div class="spinner-container">
    <mat-progress-spinner mode="indeterminate" diameter="60" strokeWidth="5">
    </mat-progress-spinner>
  </div>
  }
</section>
